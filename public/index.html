<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Follow Me Car Control Panel</title>
    <link rel="stylesheet" href="/assets/css/pico.min.css">
</head>
<body>
    <main class="container">
        <section id="slides">
            <label for="speed" id="speed_label">
                Speed
            </label>
            <input id="speed" type="range" name="speed" min="1" max="250" value="250">
        </section>
        <section id="sticker">
            <div id="nipplejs" style="height: 40vh; position: relative;"></div>
        </section>
        <section id="buttons">
            <div class="grid">
                <button class="secondary" id="avoid_btn">Avoid Switch</button>
                <button class="secondary" id="stop_btn">Stop</button>
                <button class="secondary" id="motor_btn">Motor Power</button>
            </div>
        </section>
    </main>
    <script src="/assets/js/nipplejs.js"></script>
    <script>
        var sticker = nipplejs.create({
            zone: document.getElementById("nipplejs"),
            mode: 'static',
            position: {
                left: '50%',
                top: '50%'
            },
            size: 200,
        });

        /** Configuration Constants **/
        const PERIODICALLY_MOVE_TIME = 500;
        const MAX_DISTANCE = 150;
        const MIN_DISTANCE = 85;

        /** Runtime Variables **/
        var ws = new WebSocket("ws://" + location.host + "/ws");
        var state_motor = false;
        var state_avoid = false;
        var last_distance = 0;
        var last_angual = 0;
        var last_move_time = 0;

        ws.onopen = function() {
            ws.send("get speed");
            ws.send("get avoid");
            ws.send("get motor");

            setInterval(send_move_periodically, PERIODICALLY_MOVE_TIME);
        }

        ws.onmessage = function(e) {
            if (typeof e.data === "string") {
                let i = e.data.indexOf(' ');
                let s = e.data;
                let splited = [s.slice(0, i), s.slice(i + 1)];
                let statusCode = parseInt(splited[0], 10);
                if (isNaN(statusCode)) {
                    console.error(`Invalid response code: ${splited[0]}`);
                }

                if (statusCode == 100) {
                    // Informative messages
                    let pair = splited[1].split(' ');
                    let name = pair[0];
                    let value = pair[1];
                    if (name == "motor") {
                        let val = parseBool(value);
                        if (val !== null) {
                            setMotorState(val);
                        }
                    } else if (name == "avoid") {
                        let val = parseBool(value);
                        if (val !== null) {
                            setAvoidState(val);
                        }
                    } else if (name == "speed") {
                        let val = parseInt(value, 10);
                        if (!isNaN(val)) {
                            let slider = document.getElementById("speed");
                            slider.value = val;

                            let label = document.getElementById("speed_label");
                            label.innerText = `Speed: ${slider.value} RPM`;
                        }
                    }
                } else if (statusCode >= 400) {
                    // Error messages
                    console.error(`[${statusCode}] ${splited[1]}`);
                }
            }
        };

        document.getElementById("speed").addEventListener('input', function(e) {
            let slider = e.target;
            let label = document.getElementById("speed_label");

            label.innerText = `Speed: ${slider.value} RPM`;
        });
        document.getElementById("speed").addEventListener('change', function(e) {
            let slider = e.target;
            ws.send(`set speed ${slider.value}`);
        });
        document.getElementById("avoid_btn").addEventListener('click', function(e) {
            setAvoidState(!state_avoid);
            ws.send(`set avoid ${state_avoid}`);
        });
        document.getElementById("stop_btn").addEventListener('click', function(e) {
            ws.send("stop");
        });
        document.getElementById("motor_btn").addEventListener('click', function(e) {
            setMotorState(!state_motor);
            ws.send(`set motor ${state_motor}`);
        });
        sticker.on('move', function(e, data) {
            let angual = data.angle.degree - 90;
            if (angual > 180) {
                angual = angual - 360;
            }
            let upward = Math.abs(Math.sin(data.angle.radian));
            let r = data.distance / (data.instance.options.size / 2);
            // Since our controller has a safe minimum distance,
            // we have to let the distance larger than that value.
            let distance = Math.max(MAX_DISTANCE * upward * r, MIN_DISTANCE);

            last_distance = distance;
            last_angual = angual;
            last_move_time = Date.now();

            ws.send(`move ${distance} ${angual}`);
        });
        sticker.on('end', function(e, data) {
            // DO NOT modify last_distance & last_angual to other value than 0!!
            last_distance = 0;
            last_angual = 0;
            last_move_time = Date.now();

            ws.send(`move 0 0`);
        });

        function send_move_periodically() {
            if ((last_distance > 0) && (Date.now() - last_move_time >= PERIODICALLY_MOVE_TIME)) {
                ws.send(`move ${last_distance} ${last_angual}`);
            }
        }

        function setAvoidState(value) {
            let btn = document.getElementById("avoid_btn");
            if (value === true) {
                state_avoid = value;
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else if (value === false) {
                state_avoid = value;
                btn.classList.add('secondary');
                btn.classList.remove('primary');
            }
        }

        function setMotorState(value) {
            let btn = document.getElementById("motor_btn");
            if (value === true) {
                state_motor = value;
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else if (value === false) {
                state_motor = value;
                btn.classList.add('secondary');
                btn.classList.remove('primary');
            }
        }

        function parseBool(str) {
            let s = str.toLowerCase();
            if (s == "true") {
                return true;
            } else if (s == "false") {
                return false;
            } else {
                console.error("Invalid boolean string");
                return null;
            }
        }
    </script>
</body>
</html>
